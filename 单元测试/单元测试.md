# 单元测试框架mocha

## 1、什么是单元测试

- 单元测试又称为模块测试，是针对程序模块(软件设计的最小单位)来进行正确性检验的测试工作。
- 单元测试主要是用来检验程式的内部逻辑，也称为个体测试、结构测试或逻辑驱动测试。
- 通常由撰写程式码的程式设计师负责进行

## 2、单元测试的必要性

- 由于存在浏览器解析环境、用户操作习惯等差异，前端程序的许多问题是无法捕捉或重现的，现在前端程序的测试多是黑盒测试，即靠点击点击点击来寻找程序bug。这种方式既费时费力，又无法保证测试的覆盖面。
- 同时，前端逻辑和交互越来越复杂，和其他编程语言一样，一个函数，一个模块，在修改bug或添加新功能的过程中，很容易就产生新的bug，或使老的bug复活。这种情况下，反复进行黑盒测试，其工作量和测试质量是可想而知的。
- 为什么我们的前端程序如此脆弱？就是因为没用单元测试

## 3、为什么选这种单元测试

- mocha的特点主要有：

1. 既可以测试简单的JavaScript函数，又可以测试异步代码，因为异步是JavaScript的特性之一；
2. 可以自动运行所有测试，也可以只运行特定的测试；
3. 可以支持before、after、beforeEach和afterEach来编写初始化代码。

- [chai](http://chaijs.com/api/)

  - `chai` 是一个常常被拿来与 `mocha` 一起使用的断言库，提供了丰富的断言接口，可以对各种结果进行断言。

    ​

## 4、如何进行单元测试

### 实例

```javascript
var assert = require("assert");
describe('Array', function(){
    describe('#indexOf()', function(){
        it('should return -1 when the value is not present', function(){
            assert.equal(-1, [1,2,3].indexOf(5));
            assert.equal(-1, [1,2,3].indexOf(0));
        })
    })
});
```

- describe (moduleName, testDetails)
  由上述代码可看出，describe是可以嵌套的，比如上述代码嵌套的两个describe就可以理解成测试人员希望测试Array模块下的#indexOf() 子模块。module_name 是可以随便取的，关键是要让人读明白就好。
- it (info, function)
  具体的测试语句会放在it的回调函数里，一般来说info字符串会写期望的正确输出的简要一句话文字说明。当该it block内的test failed的时候控制台就会把详细信息打印出来。一般是从最外层的describe的module_name开始输出（可以理解成沿着路径或者递归链或者回调链），最后输出info，表示该期望的info内容没有被满足。一个it对应一个实际的test case
- assert.equal (exp1, exp2)
  断言判断exp1结果是否等于exp2, 这里采取的等于判断是== 而并非 === 。即 assert.equal(1, ‘1’) 认为是True。这只是nodejs里的assert.js的一种断言形式，下文会提到同样比较常用的chai模块。

### mocha命令参数

mocha命令的基本格式是：`mocha [debug] [options] [files]`

options包括下面这些：

```javascript
     -h, --help                              输出帮助信息    
     -V, --version                           输出mucha版本    
     -A, --async-only                        强制让所有测试用例必须使用callback或者返回promise的方式来异步判断正确性    
     -c, --colors                            启用报告中颜色    
     -C, --no-colors                         禁用报告中颜色    
     -G, --growl                             enable growl notification support    
     -O, --reporter-options <k=v,k2=v2,...>  reporter-specific options    
     -R, --reporter <name>                   specify the reporter to use    
     -S, --sort                              排序测试文件    
     -b, --bail                              bail after first test failure    
     -d, --debug                             enable node's debugger, synonym for node --debug
     -g, --grep <pattern>                    只执行满足 <pattern>格式的用例    
     -f, --fgrep <string>                    只执行含有 <string> 的用例    
     -gc, --expose-gc                        展示gc回收的log    
     -i, --invert                            让 --grep 和 --fgrep 的匹配取反    
     -r, --require <name>                    require一下<name>指定的模块    
     -s, --slow <ms>                         指定slow时间（单位ms，默认75ms）    
     -t, --timeout <ms>                      指定超时时间（单位ms，默认2000ms）    
     -u, --ui <name>                         指定user-interface (bdd|tdd|exports)    
     -w, --watch                             观察用例文件变化，并重新执行    
     --check-leaks                           检测未回收global变量泄露    
     --compilers <ext>:<module>,...          用指定的模块来编译文件    
     --debug-brk                             启用node的debug模式    
     --delay                                 等待异步的用例集（见前边的）    
     --es_staging                            enable all staged features    
     --full-trace                            display the full stack trace    
     --globals <names>                       allow the given comma-delimited global [names]    
     --harmony                               enable all harmony features (except typeof)    
     --harmony-collections                   enable harmony collections (sets, maps, and weak maps)    
     --harmony-generators                    enable harmony generators    
     --harmony-proxies                       enable harmony proxies    
     --harmony_arrow_functions               enable "harmony arrow functions" (iojs)    
     --harmony_classes                       enable "harmony classes" (iojs)    
     --harmony_proxies                       enable "harmony proxies" (iojs)    
     --harmony_shipping                      enable all shipped harmony features (iojs)    
     --inline-diffs                          显示预期和实际结果的string差异比较    
     --interfaces                            display available interfaces    
     --no-deprecation                        silence deprecation warnings    
     --no-exit                               require a clean shutdown of the event loop: mocha will not call process.exit    
     --no-timeouts                           禁用timeout，可通过--debug隐式指定    
     --opts <path>                           定义option文件路径    
     --prof                                  显示统计信息    
     --recursive                             包含子目录    
     --reporters                             展示可用报告    
     --retries                               设置失败用例重试次数    
     --throw-deprecation                     每次调用deprecated函数的时候都抛出一个异常    
     --trace                                 显示函数调用栈    
     --trace-deprecation                     启用的时候显示调用栈    
     --watch-extensions <ext>,...            --watch监控的扩展  
```



### 单元测试方式

#### 1、基于node执行

- mocha object.test.js

####  2、浏览器测试结果浏览

- 动态生成模板：`mocha init test`，其中test可为任意包名。
- 其中test.js是空的，需要自己写，建议将test.js改成object.test.js。
- 在html中添加断言库、对应需要测试的target.js、单元测试object.test.js。例如：
  - 添加断言：`<script src="http://chaijs.com/chai.js"></script>`
  - 添加需要测试的js：`<script src="target.js"></script>`
  - 添加单元测试js：`<script src="test.js"></script>`
- ​





## 参考

- [mocha官网](https://mochajs.org/)
- https://www.awesomes.cn/repo/mochajs/mocha
- [测试框架 Mocha 实例教程](http://www.ruanyifeng.com/blog/2015/12/a-mocha-tutorial-of-examples.html)
- http://www.cnblogs.com/Leo_wl/p/5734889.html